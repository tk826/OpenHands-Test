# 機能全体設計書

## 1. システム概要
本システムは、AWS S3バケットからCSVファイルをダウンロードし、データの検証・加工を行い、再度S3へアップロードするバッチ処理を提供します。主な処理はPythonスクリプトで実装されています。

## 2. 処理フロー図

```mermaid
graph TD;
    A[開始] --> B[S3からのCSVファイル一覧取得・ダウンロード]
    B --> C[データ検証・警告出力・データ加工]
    C --> D[ZIP圧縮・S3アップロード]
    D --> I[終了]
```

## 3. 機能一覧
1. S3からのCSVファイル一覧取得・ダウンロード
2. データ検証・警告出力・データ加工
3. ZIP圧縮・S3アップロード
4. 複数CSVのZIP圧縮

## 4. 各機能の詳細
---

## 4.x ソースコードから設計書へのリバース手順

本リポジトリのPythonスクリプト群（`s3_download.py`, `check_process.py`, `s3_upload.py`, `script.py`）から設計書（本ファイル）を再構築するには、以下の手順を参考にしてください。

1. **機能抽出**
   - 各スクリプトの関数・クラス・コマンドライン引数・処理フローを確認し、主要な機能単位（例：S3ダウンロード、検証、アップロード、ZIP圧縮など）を抽出します。
   - 関数名・docstring・コメントをもとに、設計書の「機能一覧」「各機能の詳細」セクションを記述します。

2. **処理フロー図の作成**
   - スクリプトのmain関数やif __name__ == "__main__"ブロックの処理順序をもとに、Mermaid記法で処理フロー図を作成します。
   - 例：`script.py`のmain関数は「S3ダウンロード→検証→S3アップロード」の順で呼び出し。

3. **引数・環境変数の整理**
   - 各スクリプトのコマンドライン引数や.envファイルで指定する環境変数を一覧化し、設計書の「環境変数」や「ディレクトリ構成」セクションに反映します。

4. **型定義・検証仕様の記述**
   - `columns.txt`や検証スクリプトのロジックをもとに、カラム名・型・検証仕様（例：日付型・数値型の不正値検出、警告出力など）を設計書に記載します。

5. **テスト仕様の記述**
   - `test_*.py`の内容をもとに、どのようなテストが実装されているか、設計書にまとめます。

---


本設計では、関連する機能をまとめて記載しています。
### 4.1 S3からのCSVファイル一覧取得・ダウンロード
```mermaid
graph TD;
    A[開始] --> B[S3からCSV一覧取得]
    B --> C[CSVダウンロード]
    C --> E[終了]
```
- 指定バケット・プレフィックス・日付でCSVファイルをリストアップし、対象CSVをダウンロードする
- `s3_download.py` の `list_csv_files` および `download_csv` 関数で実装

### 4.2 データ検証・警告出力・データ加工
```mermaid
graph TD;
    A[開始] --> B[型・日付・数値チェック]
    B --> C[警告出力]
    C --> D[DataFrame加工（欠損値補完・不要カラム削除等）]
    D --> E[終了]
```
- columns.txtで定義された型情報に基づき、各カラムの型チェックや日付型・数値型の不正値検出、警告出力を行い、必要に応じてDataFrameの加工処理（例：欠損値補完、不要カラム削除等）を実施
- `check_process.py` の `check_values` 関数等で実装

### 4.3 ZIP圧縮・S3アップロード
```mermaid
graph TD;
    A[開始] --> B[複数CSVのZIP圧縮]
    B --> C[CSVをS3へアップロード]
    C --> E[終了]
```
- 複数CSVファイルをZIP形式でまとめて、S3へアップロードする
- `s3_upload.py` の `zip_csv_files` および ``upload_csv 関数で実装

## 5. ディレクトリ構成
- script.py: メインバッチスクリプト
- s3_download.py: S3からのダウンロード関連
- s3_upload.py: S3へのアップロード・ZIP圧縮関連
- check_process.py: データ検証処理
- columns.txt: カラム名と型定義
- test_*.py: 各種ユニットテスト

## 6. 環境変数
- .envファイルでS3バケット名、プレフィックス、日付、ダウンロードディレクトリ等を指定

---
2025年6月11日 作成
